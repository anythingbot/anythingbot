<!DOCTYPE html>
<html>
    <head>
        <link rel="icon" type="image/ico" href="/favicon.ico?raw=true">
        <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
        <script src="/js/lib/cookie.js"></script>
        <script>

function updateHello(hellomsg) {
    var helloElt = document.createElement("div");
    helloElt.innerHTML = hellomsg;
    document.getElementById('hellodiv').appendChild(helloElt);
}

var host = window.document.location.host.replace(/:.*/, '');
var ws = new WebSocket('ws://' + host + ':3010');
window.addEventListener('beforeunload',function () { ws.close(); });
ws.onmessage = function (event) {
    var msg = JSON.parse(event.data).content;
    if (msg.substring(0,"new opentime".length) == "new opentime") {
        // new opentime HANDLE TAG TIME
        // TIME format is Date.now()
        var args = msg.substring("new opentime ".length,msg.length);
        var argArray = args.split(" ");
        setCookie("opentime",argArray[2],14);
    }
    updateHello(msg);
};

// HUMAN: enter your handle into the HTML element handleInput and press the
//        setHandle() button to set your handle
function setHandle() {
    var handleString = document.getElementById('handleInput').value;
    setCookie("handle",handleString,365);
}

function getHandle() {
    var handleString = getCookie("handle");
    var elt = document.getElementById('handleInput');
    elt.value = handleString;
}

// HUMAN: enter your tag into the HTML element tagInput and press the setTag()
//        button to set your file tag
function setTag() {
    var tagString = document.getElementById('tagInput').value;
    setCookie("tag",tagString,14);
}

function getTag() {
    var tagString = getCookie("tag");
    var elt = document.getElementById('tagInput');
    elt.value = tagString;
}

// HUMAN: set your handle, set your tag, and press newOpentime() to open a new
// file with the given tag
function newOpentime() {
    sayhello("new opentime " + getCookie("handle") + " " + getCookie("tag"));
}

function setOpentime() {
    var opentimeString = document.getElementById('opentimeInput').value;
    setCookie("opentime",opentimeString,14);
}

function getOpentime() {
    var opentimeString = getCookie("opentime");
    var elt = document.getElementById('opentimeInput');
    elt.value = opentimeString;
}

var chrLookup = [
    '', '', '', '', '', '', '', '', '', '\t', '\n', '', '', '', '', '',
    '', '', '', '', '', '', '', '', '',   '',   '', '', '', '', '', '',
    ' ', '!', '"', '#', '$', '%', '&', "'", '(', ')', '*', '+', ',', '-', '.',
    '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', ':', ';', '<', '=',
    '>', '?', '@', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L',
    'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '[',
    '\\', ']', '^', '_', '`', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j',
    'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y',
    'z', '{', '|', '}', '~'];

function chr(n) {
    if (n == 9 || n == 10 || (n >= 32 && n <= 126)) {
        return chrLookup[n];
    } else {
        throw new Error("chr: invalid character");
    }
}

function ispchr(n) {
    return (n >= 33 && n <= 126);
}

function ischr(n) {
    return (n == 9 || n == 10 || (n >= 32 && n <= 126));
}

function pchr(n) {
    if (n >= 33 && n <= 126) {
        return chrLookup[n];
    } else {
        throw new Error("pchr: invalid character");
    }
}

var ordLookup = {
    ' ': 32, '$': 36, '(': 40, ',': 44, '0': 48, '4': 52, '8': 56, '<': 60,
    '@': 64, 'D': 68, 'H': 72, 'L': 76, 'P': 80, 'T': 84, 'X': 88, '\\': 92,
    '`': 96, 'd': 100, 'h': 104, 'l': 108, 'p': 112, 't': 116, 'x': 120,
    '|': 124, '#': 35, "'": 39, '+': 43, '/': 47, '3': 51, '7': 55, ';': 59,
    '?': 63, 'C': 67, 'G': 71, 'K': 75, 'O': 79, 'S': 83, 'W': 87, '[': 91,
    '_': 95, 'c': 99, 'g': 103, 'k': 107, 'o': 111, 's': 115, 'w': 119,
    '{': 123, '\n': 10, '"': 34, '&': 38, '*': 42, '.': 46, '2': 50, '6': 54,
    ':': 58, '>': 62, 'B': 66, 'F': 70, 'J': 74, 'N': 78, 'R': 82, 'V': 86,
    'Z': 90, '^': 94, 'b': 98, 'f': 102, 'j': 106, 'n': 110, 'r': 114,
    'v': 118, 'z': 122, '~': 126, '\t': 9, '!': 33, '%': 37, ')': 41,
    '-': 45, '1': 49, '5': 53, '9': 57, '=': 61, 'A': 65, 'E': 69, 'I': 73,
    'M': 77, 'Q': 81, 'U': 85, 'Y': 89, ']': 93, 'a': 97, 'e': 101, 'i': 105,
    'm': 109, 'q': 113, 'u': 117, 'y': 121, '}': 125
};

// look up character c in the character->ordinal chart
function ord(c) {
    if (ordLookup[c]) {
        return ordLookup[c];
    } else {
        throw new Error("ord: invalid code");
    }
}

// is it possible to look up character c in the character->ordinal chart?
function isord(c) {
    return (!! ordLookup[c]);
}

function ispord(c) {
    return (isord(c) && ispchr(ord(c)));
}

var state = {cmd:'',cmdHistory:[],cmdCursor:null,ctx:null};

function makespan(c) {
    var cElt = document.createElement("span");
    if (c == ' ') {
        cElt.innerHTML = '&nbsp;';
    } else {
        cElt.innerHTML = c;
    }
    return cElt;
}

function attachHeli() {
    var ctrls = document.createElement('div');
    var e = document.createElement('input');
    e.setAttribute('id','heliParams');
    e.setAttribute('value',"50;-55,55,-50,50;1;-1[70]+0;10,30,70;1;1");
    ctrls.appendChild(e);

    e = document.createElement('button');
    e.setAttribute('onclick',"drawheli()");
    e.innerHTML = "drawheli()";
    ctrls.appendChild(e);

    e = document.createElement('button');
    e.setAttribute('onclick',"clearCanvas()");
    e.innerHTML = "clearCanvas()";
    ctrls.appendChild(e);

    var ctrls2 = document.createElement('div');
    e = document.createElement('input');
    e.setAttribute('id','cardParams');
    ctrls2.appendChild(e);

    e = document.createElement('button');
    e.setAttribute('onclick',"drawcard()");
    e.innerHTML = "drawcard()";
    ctrls2.appendChild(e);

    var view = document.createElement('canvas');
    view.setAttribute('id','hellocanvas');
    view.setAttribute('width',300);
    view.setAttribute('height',300);
    view.setAttribute('style','border:1px solid #000000;');
    var c = document.getElementById('canvasdiv');
    c.appendChild(ctrls);
    c.appendChild(ctrls2);
    c.appendChild(view);
    initContext();
    clearCanvas();
}

function rollbackCmdHistory() {
    // compute state.cmdCursor
    if (state.cmdCursor === null) {
        state.cmdCursor = state.cmdHistory.length - 1;
    }
    // compute state.cmd based on state.cmdCursor and state.cmdHistory
    if (state.cmdCursor == null) {
        state.cmdCursor = state.cmdHistory.length - 1;
    } else if (state.cmdCursor > 0) {
        state.cmdCursor -= 1;
    }
    state.cmd = state.cmdHistory[state.cmdCursor];
    // clear cmdElt children
    var cmdElt = document.getElementById('cmddiv');
    var children = cmdElt.children;
    while (children.length > 0) {
        cmdElt.removeChild(children[0]);
    }
    // append character spans to cmdElt
    var i;
    for (i = 0; state.cmd.length > i; i += 1) {
        cmdElt.appendChild(makespan(state.cmd[i]));
    }
}

function virtualKbd(k) {
    var cmdElt = document.getElementById('cmddiv');
    cmdElt.appendChild(makespan(k));
    state.cmd = state.cmd + k;
}

function getKey(keyCode,shiftKey) {
    if (shiftKey) {
        if (keyCode >= 65 && keyCode <= 90) {
            return chr(keyCode);
        } else if (keyCode >= 48 && keyCode <= 57) {
            return decodeShiftNumberArray[keyCode - 48];
        }
        // handle punctuation
        return '?';
    }
    // ! shiftKey
    if (keyCode >= 65 && keyCode <= 90) {
        return chr(keyCode + 32);
    } else if (keyCode >= 48 && keyCode <= 57) {
        return chr(keyCode);
    }
    // handle punctuation
    return '?';
}

var decodeShiftNumberArray = [')','!','@','#','$','%','^','&','*','('];

function pageLoaded() {
    getHandle();
    getTag();
    getOpentime();
    var kbdspan = document.getElementById('kbddiv');
    var qspan = kbdspan.children[0];
    var qbtn = qspan.children[0];
    qbtn.addEventListener('click', function () { virtualKbd('Q');});
    console.log(qbtn);
    document.body.onkeydown = function (e) {
        if (! (e.srcElement === document.body ||
               e.target === document.body)) {
            return;
        }
        if (e.keyCode == 16) {
            return;
        }
        // console.log(e);
        // console.log(e.keyCode);
        // console.log(getKey(e.keyCode,e.shiftKey));
        // console.log(ispord(getKey(e.keyCode,e.shiftKey)));
        if (e.keyCode == 13 && state.cmd) {
            var cmdElt = document.getElementById('cmddiv');
            var children = cmdElt.children;
            while (children.length > 0) {
                cmdElt.removeChild(children[0]);
            }
            sayhello(state.cmd,0);
            state.cmdHistory.push(state.cmd);
            updateHello(state.cmd);
            state.cmd = '';
            state.cmdCursor = null;
        } else if (e.keyCode == 38) {
            rollbackCmdHistory();
        } else if (e.keyCode == 8 && state.cmd) {
            state.cmd = state.cmd.substring(0,state.cmd.length - 1);
            var cmdElt = document.getElementById('cmddiv');
            cmdElt.removeChild(cmdElt.children[cmdElt.children.length - 1]);
        } else if (e.key == ' ' || ispord(e.key)) {
            var cmdElt = document.getElementById('cmddiv');
            cmdElt.appendChild(makespan(e.key));
            state.cmd = state.cmd + e.key;
        } else if (e.keyCode == 32 || ispord(getKey(e.keyCode,e.shiftKey))) {
            var key = getKey(e.keyCode,e.shiftKey);
            // console.log(key);
            var cmdElt = document.getElementById('cmddiv');
            cmdElt.appendChild(makespan(key));
            state.cmd = state.cmd + key;
        }
    };
}

function canvasClick(e) {
    console.log(e.layerX);
    console.log(e.layerY);
    console.log(e);
}

function initContext() {
    var canvasElt = document.getElementById('hellocanvas');
    canvasElt.addEventListener("mousedown",canvasClick,false);
    // canvasElt.addEventListener("mouseup",canvasClick,false);
    // canvasElt.addEventListener("mousemove",canvasClick,false);
    state.ctx = canvasElt.getContext("2d");
}

function clearCanvas() {
    var ctx = state.ctx;
    ctx.clearRect(0,0,600,600);
}

function incarray(index,limit) {
    var i;
    for (i = 0; i < index.length; i += 1) {
        index[i] += 1;
        if (index[i] == limit[i]) {
            index[i] = 0;
            continue;
        } else {
            break;
        }
    }
}

function drawHeliArray(params, radiuslimit) {
    if (! params instanceof Array) {
        return;
    }
    var innerRadiusA = params[0].split(',');
    var outerRadiusA = params[1].split(',');
    var innerFactorA = params[2].split(',');
    var outerFactorA = params[3].split(',');
    var limit = [innerRadiusA.length, outerRadiusA.length,
        innerFactorA.length, outerFactorA.length];
    var index = [0,0,0,0];
    var ctx = state.ctx;
    var i;
    var n = 180;
    var xOrigin = 150;
    var yOrigin = 150;
    while (1) {
        var innerRadius = innerRadiusA[index[0]];
        var outerRadius = outerRadiusA[index[1]];
        var innerFactor = innerFactorA[index[2]];
        var outerFactor = outerFactorA[index[3]];
        for (i = 0; i < n; i += 1) {
            var innerRadians = innerFactor * 2 * Math.PI * (i / n);
            var outerRadians = outerFactor * 2 * Math.PI * (i / n);
            var x1 = innerRadius * Math.sin(innerRadians) +
                     outerRadius * Math.sin(outerRadians);
            var y1 = innerRadius * Math.cos(innerRadians) +
                     outerRadius * Math.cos(outerRadians);
            innerRadians = innerFactor * 2 * Math.PI * ((i+1) / n);
            outerRadians = outerFactor * 2 * Math.PI * ((i+1) / n);
            var x2 = innerRadius * Math.sin(innerRadians) +
                     outerRadius * Math.sin(outerRadians);
            var y2 = innerRadius * Math.cos(innerRadians) +
                     outerRadius * Math.cos(outerRadians);
            if (x1 * x1 + y1 * y1 > radiuslimit * radiuslimit &&
                    x2 * x2 + y2 * y2 > radiuslimit * radiuslimit) {
                ctx.beginPath();
                ctx.moveTo(xOrigin + x1,yOrigin + y1);
                ctx.lineTo(xOrigin + x2,yOrigin + y2);
                ctx.stroke();
            }
        }
        incarray(index,limit);
        if (index[0] == 0 && index[1] == 0 && index[2] == 0 &&
                             index[3] == 0) {
            break;
        }
    }
}

function drawcard() {
    var paramlist = document.getElementById('cardParams').value;
    var ctx = state.ctx;
    ctx.beginPath();
    ctx.moveTo(30,30);
    ctx.lineTo(120,30);
    ctx.lineTo(120,45);
    ctx.lineTo(30,45);
    ctx.lineTo(30,30);
    ctx.stroke();
}

function drawheli() {
    var paramlist = document.getElementById('heliParams').value.split('+');
    var i;
    for (i = 0; i < paramlist.length; i += 1) {
        var radiuslimit = -1;
        var term = paramlist[i];
        if (term.indexOf('[') != -1) {
            radiuslimit = term.slice(term.indexOf('['),term.length);
            var term = term.slice(0,term.indexOf('['));
            radiuslimit = radiuslimit.slice(1,radiuslimit.length-1);
        }
        var params = term.split(';');
        drawHeliArray(params, radiuslimit);
    }
}

function sayhello(content, broadcast) {
    if (content == "heli") {
        attachHeli();
        return;
    }
    if (content == "arcata") {
        updateHello("Covert Electronic Torture Weapon causes auto accident");
        updateHello("March 2017");
        updateHello("Arcata, California---a form of compulsion (torture-based");
        updateHello("control a.k.a. 'soft kill' a.k.a. 'slow kill') over");
        updateHello("movement of hands and feet was inflicted on targeted");
        updateHello("individual (TI) and as a reslt caused TI to start driving");
        updateHello("a car during a panic attack and have a car accident.");
        updateHello("The insurance company declared the wreck a total loss.");
        return;
    }
    if (ws.readyState != WebSocket.OPEN) {
        console.log("websocket is closed");
        return;
    }
    if (!content) {
        content = 'hello';
    }
    if (broadcast) {
        broadcast = 1;
    } else {
        broadcast = 0;
    }
    var data = {
        content: content,
        broadcast: broadcast
    };
    ws.send(JSON.stringify(data));
}

        </script>
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
        <title>Bot Will Accept Anything</title>
        <meta name="author" content="Sync Music Video">
        <link rel="stylesheet" type="text/css" href="/css/media.css" />
    </head>
    <body onload="pageLoaded()"><h1 id="Header">Websockets hello world</h1>

    <div class="Content">
        {{{body}}}
    </div>
    </body>
</html>
